<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pupicreditos Wallet</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f0f8ff;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
        }

        #app {
            text-align: center;
            background: #ffffff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        .hidden {
            display: none;
        }

        input {
            display: block;
            margin: 10px auto;
            padding: 10px;
            width: 80%;
            border: 1px solid #ccc;
            border-radius: 5px;
        }

        button {
            padding: 10px 20px;
            background-color: #8ecae6;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }

        button:hover {
            background-color: #219ebc;
        }

        ul {
            list-style-type: none;
            padding: 0;
        }

        .icon {
            width: 50px;
            height: 50px;
        }

        h1, h2, h3 {
            color: #023047;
        }

        #balance {
            color: #ffb703;
        }

        #supply {
            color: #ffb703;
            display: none; /* Oculto por defecto */
        }
    </style>
</head>
<body>
    <div id="app">
        <h1>Pupicreditos Wallet</h1>
        <div id="login-form">
            <h2>Login</h2>
            <input type="email" id="email" placeholder="Email">
            <input type="password" id="password" placeholder="Password">
            <button onclick="login()">Login</button>
        </div>
        <div id="wallet" class="hidden">
            <h2>Wallet</h2>
            <img src="images/pupy-icon.png" alt="Pupy Credit Icon" class="icon">
            <div id="balance">Balance: 0 Pupicreditos</div>
            <div id="supply">Remaining Supply: 10000 Pupicreditos</div>
            <button onclick="logout()">Logout</button>
            <div id="leonardo-actions" class="hidden">
                <h3>Transfer Pupicreditos</h3>
                <input type="number" id="amount" placeholder="Amount">
                <button onclick="transfer()">Transfer</button>
            </div>
            <div id="yasmin-actions" class="hidden">
                <h3>Redeem Pupicreditos</h3>
                <input type="number" id="redeemAmount" placeholder="Amount to Redeem">
                <button onclick="redeem()">Redeem</button>
                <h3>Transfer Pupicreditos to Leonardo</h3>
                <input type="number" id="transferBackAmount" placeholder="Amount to Transfer Back">
                <button onclick="transferBack()">Transfer Back</button>
            </div>
            <h3>Transactions</h3>
            <ul id="transactions"></ul>
        </div>
    </div>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCsAC7v-QXjUm4vvU7As4yRsIH9I5hgm28",
            authDomain: "pupiwallet.firebaseapp.com",
            projectId: "pupiwallet",
            storageBucket: "pupiwallet.appspot.com",
            messagingSenderId: "936137192119",
            appId: "1:936137192119:web:abdc9756a96184481b5332"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth();
        const db = getFirestore();

        let currentSupply = totalSupply;

        const loginForm = document.getElementById('login-form');
        const wallet = document.getElementById('wallet');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const amountInput = document.getElementById('amount');
        const redeemAmountInput = document.getElementById('redeemAmount');
        const transferBackAmountInput = document.getElementById('transferBackAmount');
        const balanceElement = document.getElementById('balance');
        const supplyElement = document.getElementById('supply');
        const transactionsElement = document.getElementById('transactions');
        const leonardoActions = document.getElementById('leonardo-actions');
        const yasminActions = document.getElementById('yasmin-actions');

        const userEmail = "leoalegriaspam@gmail.com";
        const girlfriendEmail = "yasminagueropreply@gmail.com";

        onAuthStateChanged(auth, user => {
            if (user) {
                if (user.email === girlfriendEmail) {
                    console.log("Yasmin is logged in:", user);
                    yasminActions.classList.remove('hidden');
                } else if (user.email === userEmail) {
                    console.log("Leonardo is logged in:", user);
                    leonardoActions.classList.remove('hidden');
                    supplyElement.style.display = "block"; // Mostrar el suministro restante solo a Leonardo
                }
                loginForm.classList.add('hidden');
                wallet.classList.remove('hidden');
                loadWallet();
            } else {
                console.log("No user is logged in");
                loginForm.classList.remove('hidden');
                wallet.classList.add('hidden');
                yasminActions.classList.add('hidden');
                leonardoActions.classList.add('hidden');
                supplyElement.style.display = "none";
            }
        });

        window.login = function login() {
            const email = emailInput.value;
            const password = passwordInput.value;
            console.log("Attempting to log in with:", email);
            signInWithEmailAndPassword(auth, email, password)
                .then((userCredential) => {
                    console.log('Logged in:', userCredential.user);
                })
                .catch(error => {
                    console.error('Error logging in:', error);
                    alert('Error logging in: ' + error.message);
                });
        }

        window.logout = function logout() {
            signOut(auth)
                .then(() => {
                    console.log('Logged out');
                })
                .catch(error => {
                    console.error('Error logging out:', error);
                    alert('Error logging out: ' + error.message);
                });
        }

        window.transfer = function transfer() {
            const amount = parseFloat(amountInput.value);
            if (isNaN(amount) || amount <= 0) {
                alert('Please enter a valid amount');
                return;
            }
            if (auth.currentUser.email !== userEmail) {
                alert("Only Leonardo can transfer Pupicreditos.");
                return;
            }
            if (currentSupply < amount) {
                alert("Insufficient Pupicreditos supply.");
                return;
            }
            const transaction = {
                from: userEmail,
                to: girlfriendEmail,
                amount,
                timestamp: serverTimestamp()
            };
            addDoc(collection(db, 'transactions'), transaction)
                .then(() => {
                    currentSupply -= amount;
                    updateSupply();
                    amountInput.value = '';
                    loadWallet();
                })
                .catch(error => {
                    console.error('Error transferring Pupicreditos:', error);
                    alert('Error transferring Pupicreditos: ' + error.message);
                });
        }

        window.redeem = function redeem() {
            const amount = parseFloat(redeemAmountInput.value);
            if (isNaN(amount) || amount <= 0) {
                alert('Please enter a valid amount to redeem');
                return;
            }
            if (auth.currentUser.email !== girlfriendEmail) {
                alert("Only Yasmin can redeem Pupicreditos.");
                return;
            }
            const transaction = {
                from: girlfriendEmail,
                to: "burn",
                amount,
                timestamp: serverTimestamp()
            };
            addDoc(collection(db, 'transactions'), transaction)
                .then(() => {
                    currentSupply += amount; // Incrementar el suministro actual al quemar tokens
                    alert(`Redeemed ${amount} Pupicreditos for $${amount} USD`);
                    redeemAmountInput.value = '';
                    loadWallet();
                })
                .catch(error => {
                    console.error('Error redeeming Pupicreditos:', error);
                    alert('Error redeeming Pupicreditos: ' + error.message);
                });
        }

        window.transferBack = function transferBack() {
            const amount = parseFloat(transferBackAmountInput.value);
            if (isNaN(amount) || amount <= 0) {
                alert('Please enter a valid amount to transfer back');
                return;
            }
            if (auth.currentUser.email !== girlfriendEmail) {
                alert("Only Yasmin can transfer Pupicreditos back to Leonardo.");
                return;
            }
            const transaction = {
                from: girlfriendEmail,
                to: userEmail,
                amount,
                timestamp: serverTimestamp()
            };
            addDoc(collection(db, 'transactions'), transaction)
                .then(() => {
                    transferBackAmountInput.value = '';
                    loadWallet();
                })
                .catch(error => {
                    console.error('Error transferring Pupicreditos back:', error);
                    alert('Error transferring Pupicreditos back: ' + error.message);
                });
        }

        function loadWallet() {
            const user = auth.currentUser;
            const q = query(collection(db, 'transactions'), where('to', '==', user.email));
            onSnapshot(q, snapshot => {
                let balance = 0;
                const transactions = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.to === "burn" && user.email === girlfriendEmail) {
                        balance -= data.amount; // Restar el monto quemado del balance
                    } else {
                        balance += data.amount; // Sumar el monto recibido al balance
                    }
                    transactions.push(data);
                });
                balanceElement.textContent = `Balance: ${balance} Pupicreditos`;
                // Mostrar solo las últimas 50 transacciones
                transactionsElement.innerHTML = transactions.slice(-50).map(t => 
                    `<li>${t.amount} Pupicreditos from ${t.from} on ${t.timestamp.toDate().toLocaleString()}</li>`).join('');
            });
            updateSupply();
        }

        function updateSupply() {
            supplyElement.textContent = `Remaining Supply: ${currentSupply} Pupicreditos`;
        }
    </script>
</body>
</html>
